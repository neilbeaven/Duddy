<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ShiftIntel - Driver Performance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-size: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
      --bg: #020817;
      --card: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97316;
      --radius-xl: 18px;
      --radius-xxl: 26px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.55);
      --gap-lg: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 14px;
      background: radial-gradient(circle at top, #111827 0, #020817 42%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: var(--gap-lg);
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .pill-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 0.66rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.18);
      backdrop-filter: blur(8px);
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 50%) no-repeat,
        var(--card);
      border-radius: var(--radius-xxl);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 253, 0.08);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-label {
      font-size: 0.74rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .section-title {
      font-size: 0.82rem;
      color: var(--muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .app-buttons {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 2px;
    }

    .app-btn {
      padding: 10px 8px;
      font-size: 0.9rem;
      border-radius: 16px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .app-btn span {
      font-weight: 600;
    }

    .app-btn.active {
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(56,189,248,0.35);
      transform: translateY(-1px);
    }

    .app-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15,23,42,0.8);
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px;
    }

    .field,
    .field-full {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    input {
      padding: 10px 10px;
      font-size: 1.05rem;
      border-radius: 14px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--text);
      outline: none;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      transition:
        border-color var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    input:focus {
      border-color: var(--accent);
      background: rgba(5, 13, 27, 1);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
      transform: translateY(-1px);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    button {
      padding: 11px 10px;
      border-radius: 999px;
      border: none;
      font-size: 1.02rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      flex: 1.6;
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      box-shadow: 0 10px 26px rgba(56,189,248,0.32);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(56,189,248,0.42);
    }

    .btn-secondary {
      flex: 1.2;
      background: rgba(9, 9, 11, 0.98);
      color: var(--muted);
      border: 1px solid rgba(75,85,99,0.9);
    }

    .btn-secondary:hover {
      background: rgba(15,23,42,1);
      color: var(--accent);
      border-color: rgba(56,189,248,0.22);
      transform: translateY(-1px);
    }

    .btn-subtle {
      flex: 0.9;
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 0.8rem;
    }

    .btn-subtle:hover {
      background: rgba(15,23,42,1);
      border-color: var(--danger);
      transform: translateY(-1px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      padding: 10px 10px 8px;
      border-radius: var(--radius-xl);
      background:
        radial-gradient(circle at top, var(--accent-soft), transparent 80%) no-repeat,
        rgba(6, 11, 23, 0.96);
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.14em;
    }

    .stat-value {
      font-size: 0.98rem;
      font-weight: 600;
      margin-top: 2px;
      line-height: 1.25;
    }

    .stat-note {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 2px;
      max-width: 180px;
    }

    .entries-card {
      max-height: 280px;
      overflow-y: auto;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(75,85,99,0.9);
      padding: 6px 6px 4px;
      background: rgba(3,7,18,0.98);
      display: flex;
      flex-direction: column;
      gap: 4px;
      scrollbar-width: thin;
    }

    .entry-row {
      display: grid;
      grid-template-columns: 0.9fr 0.9fr 1.4fr 0.8fr;
      gap: 4px;
      padding: 6px 6px;
      border-radius: 10px;
      background: rgba(9,9,11,1);
      align-items: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .entry-row span.main {
      color: var(--text);
      font-weight: 500;
      font-size: 0.74rem;
    }

    .entry-row span.app {
      color: var(--accent);
      font-weight: 500;
    }

    .entry-row span.time,
    .entry-row span.dur {
      font-size: 0.65rem;
    }

    .entry-row span.rate {
      color: #22c55e;
      font-weight: 600;
      font-size: 0.7rem;
      grid-column: 1 / 3;
      margin-top: 1px;
    }

    .entry-row span.meta {
      grid-column: 3 / 5;
      text-align: right;
      font-size: 0.6rem;
      color: #60a5fa;
      margin-top: 1px;
    }

    .entry-row span.note {
      grid-column: 1 / 5;
      font-size: 0.62rem;
      color: #6b7280;
    }

    .entry-row span.edit,
    .entry-row span.delete {
      font-size: 0.6rem;
      cursor: pointer;
      opacity: 0.78;
    }

    .entry-row span.edit {
      grid-column: 1 / 2;
      color: #38bdf8;
      margin-top: 1px;
    }

    .entry-row span.delete {
      grid-column: 4 / 5;
      text-align: right;
      color: var(--danger);
      margin-top: 1px;
    }

    .helper {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: -2px;
    }

    .running-label {
      font-size: 0.7rem;
      color: var(--accent);
      margin-top: 2px;
    }

    .manual-note {
      font-size: 0.6rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .shift-summary {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 4px;
    }

    @media (max-width: 400px) {
      .title {
        font-size: 1.7rem;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title">ShiftIntel</div>
    <div class="subtitle">Default to today. One tap to track. Built for live shifts and long term stats.</div>
    <div class="pill-row">
      <div class="pill">Shift / Week / All time</div>
      <div class="pill">Multi app</div>
      <div class="pill">Km and fuel aware</div>
    </div>
  </header>

  <!-- Step 1: App selection -->
  <section class="card">
    <div class="card-label">Step 1</div>
    <div class="section-title">Who are you online with</div>
    <div class="app-buttons" id="appButtons">
      <button class="app-btn active" data-app="Uber Eats"><span>Uber Eats</span></button>
      <button class="app-btn" data-app="DoorDash"><span>DoorDash</span></button>
      <button class="app-btn" data-app="SkipTheDishes"><span>Skip</span></button>
      <button class="app-btn" data-app="Instacart"><span>Instacart</span></button>
      <button class="app-btn" data-app="Uber Rides"><span>Uber Rides</span></button>
      <button class="app-btn" data-app="Other"><span>Other</span></button>
    </div>
  </section>

  <!-- Shift info: km and fuel -->
  <section class="card">
    <div class="card-label">Shift info (by date)</div>
    <div class="section-title">Odometer and fuel for this date</div>
    <div class="field-grid">
      <div class="field">
        <label for="date">Active date</label>
        <input type="date" id="date" />
      </div>
      <div class="field">
        <label for="shiftStartKm">Shift start odometer (km)</label>
        <input type="number" id="shiftStartKm" inputmode="decimal" placeholder="e.g. 12345" />
      </div>
      <div class="field">
        <label for="shiftEndKm">Current / end odometer (km)</label>
        <input type="number" id="shiftEndKm" inputmode="decimal" placeholder="Update anytime" />
      </div>
      <div class="field">
        <label for="shiftFuel">Fuel used this date (L, optional)</label>
        <input type="number" id="shiftFuel" inputmode="decimal" placeholder="e.g. 6.5" />
      </div>
    </div>
    <div id="shiftKmStats" class="shift-summary">
      Set start and end km to see distance, dollars per km, and efficiency for this date.
    </div>
    <div class="helper">
      One date is treated as one shift for now. You can change the date to review or adjust past days.
    </div>
  </section>

  <!-- Step 2: Run tracking -->
  <section class="card" id="entry-card">
    <div class="card-label">Step 2</div>
    <div class="section-title">Track runs for this date</div>

    <div class="field-grid">
      <div class="field">
        <label for="earnings">Run earnings ($)</label>
        <input type="number" id="earnings" inputmode="decimal" placeholder="Total this run" />
      </div>
      <div class="field">
        <label for="orders">Orders in this run</label>
        <input type="number" id="orders" inputmode="numeric" placeholder="Trips" />
      </div>
      <div class="field">
        <label for="start">Start time (auto or manual)</label>
        <input type="time" id="start" />
      </div>
      <div class="field">
        <label for="end">End time (auto or manual)</label>
        <input type="time" id="end" />
      </div>
      <div class="field-full">
        <label for="notes">Quick note (optional)</label>
        <input type="text" id="notes" placeholder="Zone, promos, delays, stacked orders, etc." />
      </div>
    </div>

    <div class="helper">
      Normal flow: Select app, tap Start to begin, tap End to save. Manual times are allowed and kept accurate.
    </div>
    <div id="runningLabel" class="running-label"></div>
    <div class="manual-note">
      Editing an old run will load it into this form. Adjust, then save.
    </div>

    <div class="btn-row">
      <button class="btn-primary" id="startRunBtn">Start run</button>
      <button class="btn-secondary" id="endRunBtn">End run and save</button>
      <button class="btn-subtle" id="clearAllBtn">Clear all data</button>
    </div>
  </section>

  <!-- Stats -->
  <section class="card">
    <div class="card-label">Stats overview</div>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-label">Earnings</div>
        <div class="stat-value" id="statTotal">
          Today $0.00 | Week $0.00 | All $0.00
        </div>
        <div class="stat-note">All values from your saved runs. Today based on active date.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Average $ / hour</div>
        <div class="stat-value" id="statPerHour">
          Today $0.0 | Week $0.0 | All $0.0
        </div>
        <div class="stat-note">Use this to judge if a block of time is worth staying online.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Top app (all time)</div>
        <div class="stat-value" id="statTopApp">None</div>
        <div class="stat-note">Based on all runs and their hourly rate.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Hot hours (all time)</div>
        <div class="stat-value" id="statHotHours">Need more data</div>
        <div class="stat-note">Best two hour window by average hourly earnings.</div>
      </div>
    </div>
  </section>

  <!-- Recent runs -->
  <section class="card">
    <div class="card-label">Recent runs</div>
    <div class="entries-card" id="entriesList">
      <div class="helper">
        Runs show date, app, start, end, duration, hourly rate, log type, notes, and quick edit/remove.
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "shiftintel_runs_v4";
  const ACTIVE_RUN_KEY = "shiftintel_active_run_v4";
  const SHIFT_KEY = "shiftintel_shifts_v1";

  const dateEl = document.getElementById("date");
  const shiftStartKmEl = document.getElementById("shiftStartKm");
  const shiftEndKmEl = document.getElementById("shiftEndKm");
  const shiftFuelEl = document.getElementById("shiftFuel");
  const shiftKmStatsEl = document.getElementById("shiftKmStats");

  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const earningsEl = document.getElementById("earnings");
  const ordersEl = document.getElementById("orders");
  const notesEl = document.getElementById("notes");
  const entriesList = document.getElementById("entriesList");
  const runningLabel = document.getElementById("runningLabel");
  const autoTimeInfo = document.getElementById("autoTimeInfo"); // not present, kept for legacy safety

  const statTotal = document.getElementById("statTotal");
  const statPerHour = document.getElementById("statPerHour");
  const statTopApp = document.getElementById("statTopApp");
  const statHotHours = document.getElementById("statHotHours");

  const startRunBtn = document.getElementById("startRunBtn");
  const endRunBtn = document.getElementById("endRunBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  const appButtonsContainer = document.getElementById("appButtons");
  const appButtons = appButtonsContainer
    ? Array.from(appButtonsContainer.querySelectorAll(".app-btn"))
    : [];

  let selectedApp = "Uber Eats";
  let activeRun = loadActiveRun();
  let editingIndex = null;

  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  function setTodayIfEmpty() {
    if (!dateEl.value) {
      dateEl.value = todayStr();
    }
  }

  function loadEntries() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  function saveEntries(entries) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    } catch (e) {
      console.error("Failed to save entries", e);
    }
  }

  function loadShifts() {
    try {
      const raw = localStorage.getItem(SHIFT_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  function saveShifts(shifts) {
    try {
      localStorage.setItem(SHIFT_KEY, JSON.stringify(shifts));
    } catch (e) {
      console.error("Failed to save shifts", e);
    }
  }

  function getShift(date) {
    if (!date) return null;
    const shifts = loadShifts();
    return shifts.find(s => s.date === date) || null;
  }

  function upsertShift(shift) {
    if (!shift || !shift.date) return;
    const shifts = loadShifts();
    const idx = shifts.findIndex(s => s.date === shift.date);
    if (idx >= 0) {
      shifts[idx] = shift;
    } else {
      shifts.push(shift);
    }
    saveShifts(shifts);
  }

  function loadActiveRun() {
    try {
      const raw = localStorage.getItem(ACTIVE_RUN_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.startTs) return null;
      return obj;
    } catch {
      return null;
    }
  }

  function saveActiveRun(run) {
    try {
      if (!run) {
        localStorage.removeItem(ACTIVE_RUN_KEY);
      } else {
        localStorage.setItem(ACTIVE_RUN_KEY, JSON.stringify(run));
      }
    } catch (e) {
      console.error("Failed to save active run", e);
    }
  }

  function formatTimeForInput(date) {
    const h = date.getHours().toString().padStart(2, "0");
    const m = date.getMinutes().toString().padStart(2, "0");
    return h + ":" + m;
  }

  function calcHours(start, end) {
    if (!start || !end) return 0;
    const partsS = start.split(":");
    const partsE = end.split(":");
    if (partsS.length < 2 || partsE.length < 2) return 0;

    const sh = Number(partsS[0]);
    const sm = Number(partsS[1]);
    const eh = Number(partsE[0]);
    const em = Number(partsE[1]);
    if (
      Number.isNaN(sh) || Number.isNaN(sm) ||
      Number.isNaN(eh) || Number.isNaN(em)
    ) return 0;

    let startMin = sh * 60 + sm;
    let endMin = eh * 60 + em;
    if (endMin <= startMin) {
      endMin += 24 * 60;
    }
    return (endMin - startMin) / 60;
  }

  function parseDateOnly(str) {
    if (!str) return null;
    return new Date(str + "T00:00:00");
  }

  function getWeekStart(d) {
    const date = new Date(d.getTime());
    const day = date.getDay(); // 0 Sun, 1 Mon
    const diff = (day + 6) % 7; // make Monday day 0
    date.setDate(date.getDate() - diff);
    date.setHours(0, 0, 0, 0);
    return date;
  }

  function syncShiftUI() {
    const activeDate = dateEl.value || todayStr();
    const shift = getShift(activeDate);
    shiftStartKmEl.value = shift && shift.startKm != null ? shift.startKm : "";
    shiftEndKmEl.value = shift && shift.endKm != null ? shift.endKm : "";
    shiftFuelEl.value = shift && shift.fuel != null ? shift.fuel : "";
  }

  function updateShiftFromInputs() {
    const activeDate = dateEl.value || todayStr();
    if (!activeDate) return;

    const startKm = parseFloat(shiftStartKmEl.value);
    const endKm = parseFloat(shiftEndKmEl.value);
    const fuel = parseFloat(shiftFuelEl.value);

    const empty =
      (isNaN(startKm) || shiftStartKmEl.value === "") &&
      (isNaN(endKm) || shiftEndKmEl.value === "") &&
      (isNaN(fuel) || shiftFuelEl.value === "");

    if (empty) {
      const filtered = loadShifts().filter(s => s.date !== activeDate);
      saveShifts(filtered);
    } else {
      const shift = {
        date: activeDate,
        startKm: isNaN(startKm) ? null : startKm,
        endKm: isNaN(endKm) ? null : endKm,
        fuel: isNaN(fuel) ? null : fuel
      };
      upsertShift(shift);
    }

    updateShiftStats();
  }

  function updateShiftStats() {
    const entries = loadEntries();
    const activeDate = dateEl.value || todayStr();
    const shift = getShift(activeDate);
    if (!shift || shift.startKm == null || shift.endKm == null) {
      shiftKmStatsEl.textContent =
        "Set start and end km to see distance and efficiency for this date.";
      return;
    }

    const km = shift.endKm - shift.startKm;
    if (km <= 0) {
      shiftKmStatsEl.textContent = "Check km values. End should be higher than start.";
      return;
    }

    const shiftEntries = entries.filter(e => e.date === activeDate);
    const shiftEarn = shiftEntries.reduce((sum, e) => sum + e.earnings, 0);
    const shiftHours = shiftEntries.reduce((sum, e) => sum + e.hours, 0);

    const dollarsPerKm = km > 0 ? (shiftEarn / km).toFixed(2) : "0.00";
    const kmPerHour = shiftHours > 0 ? (km / shiftHours).toFixed(1) : "0.0";

    let fuelText = "";
    if (shift.fuel != null && shift.fuel > 0) {
      const lPer100 = (shift.fuel / km * 100).toFixed(1);
      fuelText = " | " + lPer100 + " L/100km";
    }

    shiftKmStatsEl.textContent =
      km.toFixed(1) + " km | $" + shiftEarn.toFixed(2) + " (" +
      dollarsPerKm + " $/km) | " + kmPerHour + " km/hr" + fuelText;
  }

  function render() {
    const entries = loadEntries();
    const activeDateStr = dateEl.value || todayStr();
    const activeDate = parseDateOnly(activeDateStr) || new Date();

    // Recent runs list
    entriesList.innerHTML = "";
    if (!entries.length) {
      const div = document.createElement("div");
      div.className = "helper";
      div.textContent =
        "Log runs to see detailed history. Each row can be edited or removed.";
      entriesList.appendChild(div);
    } else {
      entries
        .slice()
        .reverse()
        .forEach((e, idx) => {
          const row = document.createElement("div");
          row.className = "entry-row";

          const dateLabel = new Date(e.date).toLocaleDateString(undefined, {
            month: "short",
            day: "numeric"
          });

          const h = e.hours || 0;
          const rate = h > 0 ? e.earnings / h : 0;
          const typeLabel =
            e.auto === true
              ? "Auto log"
              : e.auto === false
              ? "Manual log"
              : "Legacy";

          const durLabel = h > 0 ? h.toFixed(2) + "h" : "";

          row.innerHTML = `
            <span class="main">${dateLabel}</span>
            <span class="app">${e.app}</span>
            <span class="time">${e.start || "?"} - ${e.end || "?"}</span>
            <span class="dur">${durLabel}</span>
          `;

          const rateSpan = document.createElement("span");
          rateSpan.className = "rate";
          rateSpan.textContent = h > 0 ? "$" + rate.toFixed(1) + "/hr" : "-";
          row.appendChild(rateSpan);

          const meta = document.createElement("span");
          meta.className = "meta";
          meta.textContent = typeLabel;
          row.appendChild(meta);

          if (e.notes) {
            const note = document.createElement("span");
            note.className = "note";
            note.textContent = e.notes;
            row.appendChild(note);
          }

          const edit = document.createElement("span");
          edit.className = "edit";
          edit.textContent = "Edit";
          edit.onclick = () => {
            const realIndex = entries.length - 1 - idx;
            const picked = entries[realIndex];

            editingIndex = realIndex;

            dateEl.value = picked.date;
            syncShiftUI();

            if (appButtons.length) {
              appButtons.forEach(b => {
                if (b.dataset.app === picked.app) {
                  b.classList.add("active");
                  selectedApp = picked.app;
                } else {
                  b.classList.remove("active");
                }
              });
            } else {
              selectedApp = picked.app;
            }

            startEl.value = picked.start || "";
            endEl.value = picked.end || "";
            earningsEl.value = picked.earnings;
            ordersEl.value = picked.orders || "";
            notesEl.value = picked.notes || "";

            activeRun = null;
            saveActiveRun(null);

            runningLabel.textContent =
              "Editing existing run. Adjust fields and tap Save changes.";
            endRunBtn.textContent = "Save changes";
          };
          row.appendChild(edit);

          const del = document.createElement("span");
          del.className = "delete";
          del.textContent = "Remove";
          del.onclick = () => {
            const realIndex = entries.length - 1 - idx;
            entries.splice(realIndex, 1);
            saveEntries(entries);
            if (editingIndex === realIndex) {
              editingIndex = null;
              endRunBtn.textContent = "End run and save";
              runningLabel.textContent = "";
            }
            render();
          };
          row.appendChild(del);

          entriesList.appendChild(row);
        });
    }

    // Stats: today (active date), week, all time
    let total = 0;
    let totalHours = 0;

    let todayEarn = 0;
    let todayHours = 0;

    let weekEarn = 0;
    let weekHours = 0;

    const weekStart = getWeekStart(activeDate);
    const weekEnd = new Date(weekStart.getTime());
    weekEnd.setDate(weekEnd.getDate() + 7);

    const byApp = {};
    const hourBuckets = {};

    entries.forEach(e => {
      if (!e.date) return;
      const d = parseDateOnly(e.date);
      if (!d) return;

      total += e.earnings;
      totalHours += e.hours;

      if (e.app) {
        if (!byApp[e.app]) byApp[e.app] = { earnings: 0, hours: 0 };
        byApp[e.app].earnings += e.earnings;
        byApp[e.app].hours += e.hours;
      }

      if (e.start && e.end && e.hours > 0) {
        const parts = e.start.split(":");
        const sh = parseInt(parts[0], 10);
        if (!Number.isNaN(sh)) {
          if (!hourBuckets[sh]) hourBuckets[sh] = { earnings: 0, hours: 0 };
          hourBuckets[sh].earnings += e.earnings;
          hourBuckets[sh].hours += e.hours;
        }
      }

      // Today (active date)
      if (e.date === activeDateStr) {
        todayEarn += e.earnings;
        todayHours += e.hours;
      }

      // Week containing active date
      if (d >= weekStart && d < weekEnd) {
        weekEarn += e.earnings;
        weekHours += e.hours;
      }
    });

    const todayRate = todayHours > 0 ? (todayEarn / todayHours).toFixed(1) : "0.0";
    const weekRate = weekHours > 0 ? (weekEarn / weekHours).toFixed(1) : "0.0";
    const allRate = totalHours > 0 ? (total / totalHours).toFixed(1) : "0.0";

    statTotal.textContent =
      "Today $" + todayEarn.toFixed(2) +
      " | Week $" + weekEarn.toFixed(2) +
      " | All $" + total.toFixed(2);

    statPerHour.textContent =
      "Today $" + todayRate +
      " | Week $" + weekRate +
      " | All $" + allRate;

    // Top app (all time)
    let topApp = "None";
    let topRate = 0;
    Object.keys(byApp).forEach(app => {
      const { earnings, hours } = byApp[app];
      if (hours > 0) {
        const r = earnings / hours;
        if (r > topRate && earnings > 0) {
          topRate = r;
          topApp = app;
        }
      }
    });
    statTopApp.textContent =
      topApp !== "None"
        ? topApp + " (" + topRate.toFixed(1) + "/hr)"
        : "None";

    // Hot hours (all time)
    let bestBucket = null;
    let bestBucketRate = 0;
    Object.keys(hourBuckets).forEach(hStr => {
      const h = parseInt(hStr, 10);
      const { earnings, hours } = hourBuckets[h];
      if (hours > 0) {
        const r = earnings / hours;
        if (r > bestBucketRate && earnings > 0) {
          bestBucketRate = r;
          bestBucket = h;
        }
      }
    });

    if (bestBucket !== null) {
      const end = (bestBucket + 2) % 24;
      const fmt = x => {
        const suf = x >= 12 ? "pm" : "am";
        const h12 = x % 12 === 0 ? 12 : x % 12;
        return h12 + suf;
      };
      statHotHours.textContent =
        fmt(bestBucket) + " to " + fmt(end) +
        " (" + bestBucketRate.toFixed(1) + "/hr)";
    } else {
      statHotHours.textContent = "Need more data";
    }

    // Running label
    if (activeRun && activeRun.startTs && !editingIndex) {
      const started = new Date(activeRun.startTs);
      const app = activeRun.app || selectedApp;
      runningLabel.textContent =
        "Running " +
        app +
        " since " +
        started.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    } else if (!editingIndex) {
      runningLabel.textContent = "";
    }

    updateShiftStats();
  }

  // App selection
  if (appButtons.length) {
    appButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        appButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedApp = btn.dataset.app;
        if (activeRun && activeRun.startTs && !editingIndex) {
          runningLabel.textContent =
            "Running " +
            selectedApp +
            " since " +
            new Date(activeRun.startTs).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            });
        }
      });
    });
  }

  // Date changes view and shift context
  dateEl.addEventListener("change", () => {
    syncShiftUI();
    render();
  });

  // Shift inputs
  [shiftStartKmEl, shiftEndKmEl, shiftFuelEl].forEach(el => {
    el.addEventListener("change", updateShiftFromInputs);
    el.addEventListener("blur", updateShiftFromInputs);
  });

  // Start run
  startRunBtn.addEventListener("click", () => {
    if (editingIndex !== null) {
      alert("Finish editing or clear the form before starting a new run.");
      return;
    }
    if (activeRun && activeRun.startTs) {
      alert("A run is already active. End it before starting another.");
      return;
    }

    const now = new Date();
    const dateStr = todayStr();

    activeRun = {
      app: selectedApp,
      startTs: now.toISOString(),
      date: dateStr
    };
    saveActiveRun(activeRun);

    dateEl.value = dateStr;
    startEl.value = formatTimeForInput(now);
    endEl.value = "";
    runningLabel.textContent =
      "Running " +
      selectedApp +
      " since " +
      now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    render();
  });

  // End run, save or edit
  endRunBtn.addEventListener("click", () => {
    const entries = loadEntries();

    // Edit existing entry
    if (editingIndex !== null) {
      const idx = editingIndex;

      const date = dateEl.value || entries[idx].date || todayStr();
      const app = selectedApp || entries[idx].app;
      const start = startEl.value || entries[idx].start;
      const end = endEl.value || entries[idx].end;
      const earnings = parseFloat(earningsEl.value || entries[idx].earnings || "0");
      const orders = parseInt(ordersEl.value || entries[idx].orders || "0", 10);
      const notes = (notesEl.value || entries[idx].notes || "").trim();

      if (!start || !end) {
        alert("Set start and end time for this run.");
        return;
      }
      if (!earnings || earnings <= 0) {
        alert("Set a valid earnings value for this run.");
        return;
      }

      const hours = calcHours(start, end);
      if (hours <= 0) {
        alert("Time range is invalid. Fix start or end.");
        return;
      }

      entries[idx] = {
        ...entries[idx],
        date,
        app,
        start,
        end,
        earnings,
        orders,
        notes,
        hours,
        auto: false
      };
      saveEntries(entries);

      editingIndex = null;
      endRunBtn.textContent = "End run and save";
      runningLabel.textContent = "";
      startEl.value = "";
      endEl.value = "";
      earningsEl.value = "";
      ordersEl.value = "";
      notesEl.value = "";

      render();
      return;
    }

    // New entry using active run or manual times
    const now = new Date();
    let usingAuto = false;

    let date = dateEl.value || todayStr();
    let app = selectedApp;
    let start;
    let end;

    if (activeRun && activeRun.startTs) {
      const startDate = new Date(activeRun.startTs);
      date = activeRun.date || date;
      app = activeRun.app || selectedApp;
      start = formatTimeForInput(startDate);
      end = formatTimeForInput(now);
      usingAuto = true;
      startEl.value = start;
      endEl.value = end;
    } else {
      start = startEl.value;
      end = endEl.value || formatTimeForInput(now);

      if (!start || !end) {
        alert("Use Start/End or fill start and end manually.");
        return;
      }
      usingAuto = false;
    }

    const earnings = parseFloat(earningsEl.value || "0");
    const orders = parseInt(ordersEl.value || "0", 10);
    const notes = notesEl.value.trim();

    if (!earnings || earnings <= 0) {
      alert("Enter earnings for this run so the stats are real.");
      return;
    }

    const hours = calcHours(start, end);
    if (hours <= 0) {
      alert("Time math looks off. Adjust start or end.");
      return;
    }

    entries.push({
      date,
      app,
      start,
      end,
      earnings,
      orders,
      notes,
      hours,
      auto: usingAuto
    });
    saveEntries(entries);

    activeRun = null;
    saveActiveRun(null);

    startEl.value = "";
    endEl.value = "";
    earningsEl.value = "";
    ordersEl.value = "";
    notesEl.value = "";
    runningLabel.textContent = "";

    render();
  });

  // Clear all
  clearAllBtn.addEventListener("click", () => {
    const ok = confirm("Wipe all runs and shift data from this device");
    if (!ok) return;

    saveEntries([]);
    saveShifts([]);
    activeRun = null;
    saveActiveRun(null);
    editingIndex = null;

    dateEl.value = todayStr();
    shiftStartKmEl.value = "";
    shiftEndKmEl.value = "";
    shiftFuelEl.value = "";
    startEl.value = "";
    endEl.value = "";
    earningsEl.value = "";
    ordersEl.value = "";
    notesEl.value = "";
    runningLabel.textContent = "";
    endRunBtn.textContent = "End run and save";

    render();
  });

  // Init
  setTodayIfEmpty();
  syncShiftUI();
  render();
});
</script>
</body>
</html>
