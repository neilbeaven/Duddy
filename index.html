<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Duddy - Driving Buddy Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-size: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
      --bg: #020817;
      --card: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97316;
      --radius-xl: 18px;
      --radius-xxl: 26px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.55);
      --gap-lg: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 56px 14px 14px;
      background: radial-gradient(circle at top, #111827 0, #020817 42%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: var(--gap-lg);
    }

    /* Top sticky bar */

    .top-bar-wrap {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 40;
      display: flex;
      justify-content: center;
      pointer-events: none;
    }

    .top-bar {
      pointer-events: auto;
      margin: 6px 10px;
      padding: 8px 12px;
      max-width: 520px;
      width: 100%;
      border-radius: 999px;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 60%) no-repeat,
        rgba(3,7,18,0.98);
      box-shadow: 0 12px 40px rgba(15,23,42,0.9);
      border: 1px solid rgba(56,189,248,0.24);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .top-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      color: var(--accent);
      white-space: nowrap;
    }

    .top-status {
      display: flex;
      flex-direction: column;
      gap: 1px;
      font-size: 0.63rem;
      color: var(--muted);
      flex: 1;
    }

    .top-status-line {
      display: flex;
      gap: 8px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .badge {
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 0.57rem;
      border: 1px solid rgba(56,189,248,0.4);
      color: var(--accent);
      background: rgba(9,9,11,1);
    }

    .badge.off {
      border-color: rgba(148,163,253,0.4);
      color: #9ca3af;
    }

    .top-btn {
      padding: 7px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      box-shadow: 0 6px 18px rgba(56,189,248,0.32);
      white-space: nowrap;
    }

    .top-btn.off {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(75,85,99,0.9);
      box-shadow: none;
    }

    /* Header */

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 0.86rem;
      color: var(--muted);
    }

    .pill-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 0.6rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.18);
      backdrop-filter: blur(8px);
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 50%) no-repeat,
        var(--card);
      border-radius: var(--radius-xxl);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 253, 0.08);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-label {
      font-size: 0.74rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .section-title {
      font-size: 0.82rem;
      color: var(--muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    /* App buttons */

    .app-buttons {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 2px;
    }

    .app-btn {
      padding: 9px 8px;
      font-size: 0.9rem;
      border-radius: 16px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .app-btn span {
      font-weight: 600;
    }

    .app-btn.active {
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(56,189,248,0.35);
      transform: translateY(-1px);
    }

    .app-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15,23,42,0.8);
    }

    /* Fields */

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px;
    }

    .field,
    .field-full {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.72rem;
      color: var(--muted);
    }

    input {
      padding: 9px 10px;
      font-size: 1.02rem;
      border-radius: 14px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--text);
      outline: none;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      transition:
        border-color var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    input:focus {
      border-color: var(--accent);
      background: rgba(5, 13, 27, 1);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
      transform: translateY(-1px);
    }

    /* Buttons */

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.98rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      flex: 1.5;
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      box-shadow: 0 10px 24px rgba(56,189,248,0.32);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(56,189,248,0.42);
    }

    .btn-end,
    .btn-patch {
      flex: 1;
      background: rgba(9, 9, 11, 0.98);
      color: var(--accent);
      border: 1px solid rgba(56,189,248,0.5);
      font-size: 0.9rem;
    }

    .btn-end {
      background: rgba(22, 163, 74, 0.16);
      color: #22c55e;
      border-color: #22c55e;
    }

    .btn-end:hover,
    .btn-patch:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15,23,42,0.9);
    }

    .btn-subtle {
      flex: 0.9;
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 0.78rem;
    }

    .btn-subtle:hover {
      background: rgba(15,23,42,1);
      border-color: var(--danger);
      transform: translateY(-1px);
    }

    /* Stats */

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      padding: 9px 10px 7px;
      border-radius: var(--radius-xl);
      background:
        radial-gradient(circle at top, var(--accent-soft), transparent 80%) no-repeat,
        rgba(6, 11, 23, 0.96);
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: 0.63rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.14em;
    }

    .stat-value {
      font-size: 0.96rem;
      font-weight: 600;
      margin-top: 1px;
      line-height: 1.2;
    }

    .stat-note {
      font-size: 0.66rem;
      color: var(--muted);
      margin-top: 2px;
      max-width: 220px;
    }

    /* Entries */

    .entries-card {
      max-height: 280px;
      overflow-y: auto;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(75,85,99,0.9);
      padding: 6px 6px 4px;
      background: rgba(3,7,18,0.98);
      display: flex;
      flex-direction: column;
      gap: 4px;
      scrollbar-width: thin;
    }

    .entry-row {
      display: grid;
      grid-template-columns: 0.9fr 0.9fr 1.3fr 0.9fr;
      gap: 4px;
      padding: 5px 6px;
      border-radius: 10px;
      background: rgba(9,9,11,1);
      align-items: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .entry-row span.main {
      color: var(--text);
      font-weight: 500;
      font-size: 0.74rem;
    }

    .entry-row span.app {
      color: var(--accent);
      font-weight: 500;
    }

    .entry-row span.time,
    .entry-row span.dur {
      font-size: 0.64rem;
    }

    .entry-row span.rate {
      color: #22c55e;
      font-weight: 600;
      font-size: 0.7rem;
      grid-column: 1 / 3;
      margin-top: 1px;
    }

    .entry-row span.meta {
      grid-column: 3 / 5;
      text-align: right;
      font-size: 0.6rem;
      color: #60a5fa;
      margin-top: 1px;
    }

    .entry-row span.note {
      grid-column: 1 / 5;
      font-size: 0.6rem;
      color: #6b7280;
    }

    .entry-row span.edit,
    .entry-row span.delete {
      font-size: 0.58rem;
      cursor: pointer;
      opacity: 0.8;
    }

    .entry-row span.edit {
      grid-column: 1 / 2;
      color: #38bdf8;
      margin-top: 1px;
    }

    .entry-row span.delete {
      grid-column: 4 / 5;
      text-align: right;
      color: var(--danger);
      margin-top: 1px;
    }

    .entry-row.summary {
      background: rgba(8, 18, 35, 1);
      border: 1px solid rgba(56,189,248,0.25);
    }

    .entry-row.summary span.main {
      color: var(--accent);
      font-weight: 600;
    }

    .entry-row.summary span.dur {
      color: #22c55e;
      font-weight: 600;
    }

    .helper {
      font-size: 0.64rem;
      color: var(--muted);
    }

    .run-label {
      font-size: 0.68rem;
      color: var(--accent);
      margin-top: 2px;
    }

    .shift-summary {
      font-size: 0.66rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Analytics */

    .analytics-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .analytics-tab {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: transparent;
      color: var(--muted);
      font-size: 0.64rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .analytics-tab.active {
      background: rgba(8, 15, 30, 0.98);
      color: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 6px 14px rgba(15,23,42,0.9);
    }

    .analytics-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.66rem;
      color: var(--muted);
    }

    .week-bars {
      display: flex;
      gap: 4px;
      align-items: flex-end;
      height: 70px;
      margin-top: 2px;
    }

    .week-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
    }

    .week-bar-fill {
      width: 100%;
      border-radius: 8px 8px 2px 2px;
      background: rgba(56,189,248,0.18);
      transition: height var(--transition-fast);
    }

    .week-bar-label {
      font-size: 0.58rem;
      color: var(--muted);
    }

    .app-share-bar {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      margin-top: 2px;
      background: rgba(15,23,42,1);
      border: 1px solid rgba(75,85,99,0.9);
    }

    .app-share-seg {
      height: 100%;
      font-size: 0;
    }

    .app-share-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.6rem;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-swatch {
      width: 9px;
      height: 9px;
      border-radius: 4px;
      background: rgba(148,163,253,0.9);
    }

    @media (max-width: 400px) {
      .title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
<div class="top-bar-wrap">
  <div class="top-bar">
    <div class="top-title">Duddy</div>
    <div class="top-status">
      <div class="top-status-line">
        <div class="badge off" id="dutyBadge">OFF DUTY</div>
        <div id="dutyInfo">Not tracking a shift.</div>
      </div>
      <div id="dutyHint">Tap Go on duty when you start your day.</div>
    </div>
    <button class="top-btn off" id="dutyToggleBtn">Go on duty</button>
  </div>
</div>

<div class="app">
  <header class="header">
    <div class="title">Duddy</div>
    <div class="subtitle">
      Driving buddy for live shifts and simple stats. One tap on duty, one tap to log runs.
    </div>
    <div class="pill-row">
      <div class="pill">Shift aware</div>
      <div class="pill">Quick run logging</div>
      <div class="pill">Multi app</div>
      <div class="pill">Km and fuel</div>
    </div>
  </header>

  <!-- Step 1: App selection -->
  <section class="card">
    <div class="card-label">Step 1</div>
    <div class="section-title">Active platform</div>
    <div class="app-buttons" id="appButtons">
      <button class="app-btn active" data-app="Uber Eats"><span>Uber Eats</span></button>
      <button class="app-btn" data-app="DoorDash"><span>DoorDash</span></button>
      <button class="app-btn" data-app="SkipTheDishes"><span>Skip</span></button>
      <button class="app-btn" data-app="Instacart"><span>Instacart</span></button>
      <button class="app-btn" data-app="Uber Rides"><span>Uber Rides</span></button>
      <button class="app-btn" data-app="Other"><span>Other</span></button>
    </div>
  </section>

  <!-- Shift info -->
  <section class="card">
    <div class="card-label">Shift info</div>
    <div class="section-title">Per date: shift time, km, fuel</div>
    <div class="field-grid">
      <div class="field">
        <label for="date">Active date</label>
        <input type="date" id="date" />
      </div>
      <div class="field">
        <label for="shiftStartTime">Shift start time</label>
        <input type="time" id="shiftStartTime" />
      </div>
      <div class="field">
        <label for="shiftEndTime">Shift end time</label>
        <input type="time" id="shiftEndTime" />
      </div>
      <div class="field">
        <label for="shiftStartKm">Start odometer (km)</label>
        <input type="number" id="shiftStartKm" inputmode="decimal" placeholder="e.g. 12345" />
      </div>
      <div class="field">
        <label for="shiftEndKm">End / current odometer (km)</label>
        <input type="number" id="shiftEndKm" inputmode="decimal" placeholder="Update anytime" />
      </div>
      <div class="field">
        <label for="shiftFuel">Fuel used this date (L)</label>
        <input type="number" id="shiftFuel" inputmode="decimal" placeholder="Optional" />
      </div>
    </div>
    <div id="shiftKmStats" class="shift-summary">
      Use this block when parked. On duty bar above shows live status.
    </div>
    <div class="btn-row">
      <button class="btn-primary" id="finalizeDayBtn">Finalize this day &amp; download CSV</button>
    </div>
    <div class="helper">
      Uses selected date above. File opens in Excel, Sheets or Numbers.
    </div>
  </section>

  <!-- Run control -->
  <section class="card">
    <div class="card-label">Runs</div>
    <div class="section-title">Start a run, then end with one tap</div>
    <div class="helper">
      Runs are chunks inside your shift. Start once, finish with End or a 10 / 20 / 30 quick button.
    </div>
    <div class="btn-row">
      <button class="btn-primary" id="startRunBtn">Start run</button>
    </div>
    <div class="btn-row">
      <button class="btn-end" id="endRunFullBtn">End</button>
      <button class="btn-patch" data-mins="10">10</button>
      <button class="btn-patch" data-mins="20">20</button>
      <button class="btn-patch" data-mins="30">30</button>
      <button class="btn-subtle" id="clearAllBtn">Clear all</button>
    </div>
    <div class="run-label" id="runStatus">No active run.</div>
  </section>

  <!-- Manual / edit run form -->
  <section class="card">
    <div class="card-label">Manual or edit</div>
    <div class="section-title">Fix a run or log one manually</div>
    <div class="field-grid">
      <div class="field">
        <label for="earnings">Run earnings ($)</label>
        <input type="number" id="earnings" inputmode="decimal" placeholder="Total this run" />
      </div>
      <div class="field">
        <label for="orders">Orders in this run</label>
        <input type="number" id="orders" inputmode="numeric" placeholder="Trips" />
      </div>
      <div class="field">
        <label for="start">Start time</label>
        <input type="time" id="start" />
      </div>
      <div class="field">
        <label for="end">End time</label>
        <input type="time" id="end" />
      </div>
      <div class="field-full">
        <label for="notes">Note (optional)</label>
        <input type="text" id="notes" placeholder="Zone, promos, delays, stacked orders, etc." />
      </div>
    </div>
    <div class="helper">
      Pick a run from the list to load it here. End button will save the edit when editing.
    </div>
  </section>

  <!-- Stats -->
  <section class="card">
    <div class="card-label">Stats</div>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-label">Earnings</div>
        <div class="stat-value" id="statTotal">
          Today $0.00 | Week $0.00 | All $0.00
        </div>
        <div class="stat-note">
          Based on all logged runs for the selected date and ranges.
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">Avg $ / hour</div>
        <div class="stat-value" id="statPerHour">
          Today $0.0 | Week $0.0 | All $0.0
        </div>
        <div class="stat-note">
          Uses run time. If shift times exist, also shows true shift hourly.
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">Top app</div>
        <div class="stat-value" id="statTopApp">None</div>
        <div class="stat-note">Based on hourly rate across runs.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Hot hours</div>
        <div class="stat-value" id="statHotHours">Need more data</div>
        <div class="stat-note">Best 2 hour window across history.</div>
      </div>
    </div>
  </section>

  <!-- Analytics -->
  <section class="card">
    <div class="card-label">Analytics</div>
    <div class="analytics-tabs">
      <button class="analytics-tab active" data-view="weekly">Weekly bars</button>
      <button class="analytics-tab" data-view="apps">App share</button>
    </div>
    <div id="analyticsContent" class="analytics-content">
      <div class="helper">
        Scroll here when parked. Charts light up once you have some runs.
      </div>
    </div>
  </section>

  <!-- Recent runs -->
  <section class="card">
    <div class="card-label">Recent runs</div>
    <div class="entries-card" id="entriesList">
      <div class="helper">
        Shows a Today summary plus each run. Duration uses hours and minutes.
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const RUNS_KEY = "duddy_runs_v1";
  const ACTIVE_RUN_KEY = "duddy_active_run_v1";
  const SHIFTS_KEY = "duddy_shifts_v1";

  // Top bar
  const dutyBadge = document.getElementById("dutyBadge");
  const dutyInfo = document.getElementById("dutyInfo");
  const dutyHint = document.getElementById("dutyHint");
  const dutyToggleBtn = document.getElementById("dutyToggleBtn");

  // Shift
  const dateEl = document.getElementById("date");
  const shiftStartTimeEl = document.getElementById("shiftStartTime");
  const shiftEndTimeEl = document.getElementById("shiftEndTime");
  const shiftStartKmEl = document.getElementById("shiftStartKm");
  const shiftEndKmEl = document.getElementById("shiftEndKm");
  const shiftFuelEl = document.getElementById("shiftFuel");
  const shiftKmStatsEl = document.getElementById("shiftKmStats");
  const finalizeDayBtn = document.getElementById("finalizeDayBtn");

  // App selection
  const appButtons = Array.from(document.querySelectorAll("#appButtons .app-btn"));

  // Manual form
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const earningsEl = document.getElementById("earnings");
  const ordersEl = document.getElementById("orders");
  const notesEl = document.getElementById("notes");

  // Run controls
  const startRunBtn = document.getElementById("startRunBtn");
  const endRunFullBtn = document.getElementById("endRunFullBtn");
  const patchButtons = Array.from(document.querySelectorAll(".btn-patch"));
  const clearAllBtn = document.getElementById("clearAllBtn");
  const runStatusEl = document.getElementById("runStatus");

  // Recent runs
  const entriesList = document.getElementById("entriesList");

  // Stats
  const statTotal = document.getElementById("statTotal");
  const statPerHour = document.getElementById("statPerHour");
  const statTopApp = document.getElementById("statTopApp");
  const statHotHours = document.getElementById("statHotHours");

  // Analytics
  const analyticsTabs = Array.from(document.querySelectorAll(".analytics-tab"));
  const analyticsContent = document.getElementById("analyticsContent");

  // State
  let selectedApp = "Uber Eats";
  let activeRun = loadActiveRun();
  let editingIndex = null;
  let shiftTimerInterval = null;
  let runTimerInterval = null;

  // Utility functions

  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  function formatTimeForInput(date) {
    const h = date.getHours().toString().padStart(2, "0");
    const m = date.getMinutes().toString().padStart(2, "0");
    return h + ":" + m;
  }

  function calcHours(start, end) {
    if (!start || !end) return 0;
    const ps = start.split(":");
    const pe = end.split(":");
    if (ps.length < 2 || pe.length < 2) return 0;
    const sh = Number(ps[0]);
    const sm = Number(ps[1]);
    const eh = Number(pe[0]);
    const em = Number(pe[1]);
    if ([sh, sm, eh, em].some(Number.isNaN)) return 0;

    let startMin = sh * 60 + sm;
    let endMin = eh * 60 + em;
    if (endMin < startMin) endMin += 24 * 60;
    const diff = endMin - startMin;
    if (diff <= 0) return 0;
    return diff / 60;
  }

  function formatDurationHM(hours) {
    if (!hours || hours <= 0) return "";
    const totalMin = Math.round(hours * 60);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    if (h > 0 && m > 0) return h + "h " + m + "m";
    if (h > 0) return h + "h";
    return m + "m";
  }

  function parseDateOnly(str) {
    if (!str) return null;
    return new Date(str + "T00:00:00");
  }

  function getWeekStart(d) {
    const date = new Date(d.getTime());
    const day = date.getDay();
    const diff = (day + 6) % 7;
    date.setDate(date.getDate() - diff);
    date.setHours(0, 0, 0, 0);
    return date;
  }

  // Storage helpers

  function loadRuns() {
    try {
      const raw = localStorage.getItem(RUNS_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error("loadRuns failed", e);
      return [];
    }
  }

  function saveRuns(runs) {
    try {
      localStorage.setItem(RUNS_KEY, JSON.stringify(runs));
    } catch (e) {
      console.error("saveRuns failed", e);
    }
  }

  function loadShifts() {
    try {
      const raw = localStorage.getItem(SHIFTS_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error("loadShifts failed", e);
      return [];
    }
  }

  function saveShifts(shifts) {
    try {
      localStorage.setItem(SHIFTS_KEY, JSON.stringify(shifts));
    } catch (e) {
      console.error("saveShifts failed", e);
    }
  }

  function getShift(date) {
    if (!date) return null;
    const shifts = loadShifts();
    return shifts.find(s => s.date === date) || null;
  }

  function upsertShift(shift) {
    if (!shift || !shift.date) return;
    const shifts = loadShifts();
    const idx = shifts.findIndex(s => s.date === shift.date);
    if (idx >= 0) shifts[idx] = shift;
    else shifts.push(shift);
    saveShifts(shifts);
  }

  function setOnDutyForDate(date) {
    const shifts = loadShifts();
    let found = shifts.find(s => s.date === date);
    if (!found) {
      found = { date, startTime: null, endTime: null, startKm: null, endKm: null, fuel: null, onDuty: false };
      shifts.push(found);
    }
    shifts.forEach(s => {
      s.onDuty = (s.date === date);
    });
    saveShifts(shifts);
    return found;
  }

  function clearOnDuty() {
    const shifts = loadShifts();
    shifts.forEach(s => { s.onDuty = false; });
    saveShifts(shifts);
  }

  function loadActiveRun() {
    try {
      const raw = localStorage.getItem(ACTIVE_RUN_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.startTs) return null;
      return obj;
    } catch (e) {
      console.error("loadActiveRun failed", e);
      return null;
    }
  }

  function saveActiveRun(run) {
    try {
      if (!run) localStorage.removeItem(ACTIVE_RUN_KEY);
      else localStorage.setItem(ACTIVE_RUN_KEY, JSON.stringify(run));
    } catch (e) {
      console.error("saveActiveRun failed", e);
    }
  }

  // Shift UI and stats

  function syncShiftInputs() {
    const activeDate = dateEl.value || todayStr();
    const shift = getShift(activeDate);
    shiftStartTimeEl.value = shift && shift.startTime ? shift.startTime : "";
    shiftEndTimeEl.value = shift && shift.endTime ? shift.endTime : "";
    shiftStartKmEl.value = shift && shift.startKm != null ? shift.startKm : "";
    shiftEndKmEl.value = shift && shift.endKm != null ? shift.endKm : "";
    shiftFuelEl.value = shift && shift.fuel != null ? shift.fuel : "";
  }

  function updateShiftFromInputs() {
    const activeDate = dateEl.value || todayStr();
    if (!activeDate) return;

    const startTime = shiftStartTimeEl.value || null;
    const endTime = shiftEndTimeEl.value || null;
    const startKm = shiftStartKmEl.value === "" ? null : parseFloat(shiftStartKmEl.value);
    const endKm = shiftEndKmEl.value === "" ? null : parseFloat(shiftEndKmEl.value);
    const fuel = shiftFuelEl.value === "" ? null : parseFloat(shiftFuelEl.value);

    const empty =
      !startTime &&
      !endTime &&
      startKm == null &&
      endKm == null &&
      fuel == null;

    if (empty) {
      const cleaned = loadShifts().filter(s => s.date !== activeDate);
      saveShifts(cleaned);
    } else {
      const existing = getShift(activeDate) || { date: activeDate, onDuty: false };
      existing.startTime = startTime;
      existing.endTime = endTime;
      existing.startKm = startKm;
      existing.endKm = endKm;
      existing.fuel = fuel;
      upsertShift(existing);
    }

    updateShiftStats();
    updateDutyBar();
    render();
  }

  function calcShiftHours(dateStr) {
    const shift = getShift(dateStr);
    if (!shift || !shift.startTime) return 0;

    let endTimeStr;
    if (shift.endTime) {
      endTimeStr = shift.endTime;
    } else if (shift.onDuty && dateStr === todayStr()) {
      endTimeStr = formatTimeForInput(new Date());
    } else {
      return 0;
    }

    return calcHours(shift.startTime, endTimeStr);
  }

  function updateShiftStats() {
    const runs = loadRuns();
    const activeDate = dateEl.value || todayStr();
    const shift = getShift(activeDate);

    if (!shift || shift.startKm == null || shift.endKm == null) {
      shiftKmStatsEl.textContent =
        "Add km to keep an eye on $ per km and fuel efficiency.";
      return;
    }

    const km = shift.endKm - shift.startKm;
    if (km <= 0) {
      shiftKmStatsEl.textContent = "Check km values. End should be higher than start.";
      return;
    }

    const dayRuns = runs.filter(r => r.date === activeDate);
    let dayEarn = 0;
    let dayRunHours = 0;

    dayRuns.forEach(r => {
      const h = calcHours(r.start, r.end);
      if (h > 0) {
        dayRunHours += h;
        dayEarn += r.earnings || 0;
      }
    });

    const dollarsPerKm = km > 0 ? (dayEarn / km).toFixed(2) : "0.00";
    const kmPerHour = dayRunHours > 0 ? (km / dayRunHours).toFixed(1) : "0.0";

    let fuelText = "";
    if (shift.fuel != null && shift.fuel > 0) {
      const lPer100 = (shift.fuel / km * 100).toFixed(1);
      fuelText = " | " + lPer100 + " L/100km";
    }

    const shiftHours = calcShiftHours(activeDate);
    let shiftText = "";
    if (shiftHours > 0 && shift.startTime) {
      const endLabel = shift.endTime ? shift.endTime : "now";
      shiftText =
        " | Shift " + shift.startTime + " - " + endLabel +
        " (" + formatDurationHM(shiftHours) + ")";
    }

    shiftKmStatsEl.textContent =
      km.toFixed(1) + " km | $" + dayEarn.toFixed(2) +
      " (" + dollarsPerKm + " $/km) | " +
      kmPerHour + " km/hr (run time)" +
      fuelText +
      shiftText;
  }

  // Duty bar

  function startShiftTimer(shift) {
    if (!shift || !shift.startTime) return;
    if (shiftTimerInterval) clearInterval(shiftTimerInterval);

    function tick() {
      const parts = shift.startTime.split(":");
      const sh = Number(parts[0]);
      const sm = Number(parts[1]);
      if (Number.isNaN(sh) || Number.isNaN(sm)) return;

      const now = new Date();
      const start = new Date(now);
      start.setHours(sh, sm, 0, 0);
      if (now < start) {
        start.setDate(start.getDate() - 1);
      }

      const diffSec = Math.max(0, Math.floor((now - start) / 1000));
      const h = Math.floor(diffSec / 3600).toString().padStart(2, "0");
      const m = Math.floor((diffSec % 3600) / 60).toString().padStart(2, "0");

      dutyInfo.textContent =
        "On duty since " + shift.startTime + " • " + h + ":" + m + " so far";
    }

    tick();
    shiftTimerInterval = setInterval(tick, 30000);
  }

  function stopShiftTimer() {
    if (shiftTimerInterval) clearInterval(shiftTimerInterval);
    shiftTimerInterval = null;
  }

  function updateDutyBar() {
    const shifts = loadShifts();
    const onDutyShift = shifts.find(s => s.onDuty);

    if (onDutyShift && onDutyShift.startTime) {
      dutyBadge.textContent = "ON DUTY";
      dutyBadge.classList.remove("off");
      dutyHint.textContent =
        "Duddy uses this for real shift hourly. Off duty when you are done.";
      dutyToggleBtn.textContent = "Off duty";
      dutyToggleBtn.classList.remove("off");
      startShiftTimer(onDutyShift);
    } else {
      dutyBadge.textContent = "OFF DUTY";
      dutyBadge.classList.add("off");
      dutyInfo.textContent = "Not tracking a shift.";
      dutyHint.textContent = "Tap Go on duty at first login of your day.";
      dutyToggleBtn.textContent = "Go on duty";
      dutyToggleBtn.classList.add("off");
      stopShiftTimer();
    }
  }

  dutyToggleBtn.addEventListener("click", () => {
    const shifts = loadShifts();
    const currentOn = shifts.find(s => s.onDuty);

    if (currentOn) {
      // Turning off
      const now = new Date();
      const suggested = formatTimeForInput(now);
      const val = prompt(
        "Shift end time for " + currentOn.date + " (HH:MM)",
        suggested
      );
      if (val === null || val.trim() === "") {
        return;
      }
      currentOn.endTime = val.trim();
      currentOn.onDuty = false;
      upsertShift(currentOn);
      updateShiftStats();
      updateDutyBar();
      render();
    } else {
      // Turning on for today
      const today = todayStr();
      let shift = setOnDutyForDate(today);
      if (!shift.startTime) {
        shift.startTime = formatTimeForInput(new Date());
      }
      shift.endTime = null;
      shift.onDuty = true;
      upsertShift(shift);
      dateEl.value = today;
      syncShiftInputs();
      updateShiftStats();
      updateDutyBar();
      render();
    }
  });

  // Run timers

  function startRunTimer() {
    if (!activeRun || !activeRun.startTs) return;
    if (runTimerInterval) clearInterval(runTimerInterval);

    function tick() {
      const startTime = new Date(activeRun.startTs).getTime();
      const now = Date.now();
      let diff = Math.max(0, Math.floor((now - startTime) / 1000));
      const h = Math.floor(diff / 3600).toString().padStart(2, "0");
      diff %= 3600;
      const m = Math.floor(diff / 60).toString().padStart(2, "0");
      const s = (diff % 60).toString().padStart(2, "0");
      runStatusEl.textContent =
        "Active run for " + (activeRun.app || selectedApp) +
        " • " + h + ":" + m + ":" + s;
    }

    tick();
    runTimerInterval = setInterval(tick, 1000);
  }

  function stopRunTimer() {
    if (runTimerInterval) clearInterval(runTimerInterval);
    runTimerInterval = null;
    if (!activeRun && editingIndex === null) {
      runStatusEl.textContent = "No active run.";
    }
  }

  // CSV export

  function exportDayCsv(dateStr) {
    const runs = loadRuns();
    const shift = getShift(dateStr);
    const dayRuns = runs.filter(r => r.date === dateStr);

    if (!dayRuns.length && !shift) {
      alert("No data for this date to export.");
      return;
    }

    const rows = [];

    rows.push([
      "Date",
      "App",
      "Start",
      "End",
      "Duration (h:m)",
      "Earnings",
      "Orders",
      "Type",
      "Notes"
    ]);

    dayRuns.forEach(r => {
      const h = calcHours(r.start, r.end);
      const durHM = formatDurationHM(h);
      const typeLabel =
        r.quick
          ? "Quick patch"
          : r.auto === true
          ? "Auto"
          : r.auto === false
          ? "Manual"
          : "Legacy";

      rows.push([
        r.date || "",
        r.app || "",
        r.start || "",
        r.end || "",
        durHM || "",
        r.earnings != null ? String(r.earnings) : "",
        r.orders != null ? String(r.orders) : "",
        typeLabel,
        r.notes ? r.notes.replace(/\r?\n/g, " ") : ""
      ]);
    });

    rows.push([]);

    if (shift) {
      rows.push(["Shift summary"]);
      rows.push(["Date", shift.date || ""]);
      rows.push(["Shift start", shift.startTime || ""]);
      rows.push(["Shift end", shift.endTime || ""]);
      rows.push(["Start km", shift.startKm != null ? shift.startKm : ""]);
      rows.push(["End km", shift.endKm != null ? shift.endKm : ""]);
      rows.push(["Fuel (L)", shift.fuel != null ? shift.fuel : ""]);

      if (shift.startKm != null && shift.endKm != null && shift.endKm > shift.startKm) {
        const km = shift.endKm - shift.startKm;
        const runsTotal = dayRuns.reduce((s, r) => s + (r.earnings || 0), 0);
        const dollarsPerKm = km > 0 ? (runsTotal / km).toFixed(2) : "";
        rows.push(["Total km", km.toFixed(1)]);
        rows.push(["Total run earnings", runsTotal.toFixed(2)]);
        rows.push(["$/km", dollarsPerKm]);
      }
    }

    const csv = rows
      .map(cols =>
        cols
          .map(v => {
            const val = v == null ? "" : String(v);
            if (/[",\n]/.test(val)) {
              return '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
          })
          .join(",")
      )
      .join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "duddy-" + dateStr + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Analytics

  function renderAnalytics(runs) {
    const activeTab = analyticsTabs.find(t => t.classList.contains("active"));
    if (!activeTab) return;
    analyticsContent.innerHTML = "";

    if (!runs.length) {
      const d = document.createElement("div");
      d.className = "helper";
      d.textContent = "Log some runs and Duddy will chart them here.";
      analyticsContent.appendChild(d);
      return;
    }

    const view = activeTab.dataset.view;
    const activeDateStr = dateEl.value || todayStr();
    const activeDate = parseDateOnly(activeDateStr) || new Date();

    if (view === "weekly") {
      const weekStart = getWeekStart(activeDate);
      const weekEnd = new Date(weekStart.getTime());
      weekEnd.setDate(weekEnd.getDate() + 7);

      const daily = [0, 0, 0, 0, 0, 0, 0];

      runs.forEach(r => {
        if (!r.date) return;
        const d = parseDateOnly(r.date);
        if (!d || d < weekStart || d >= weekEnd) return;
        const h = calcHours(r.start, r.end);
        if (h <= 0) return;
        const earn = r.earnings || 0;
        const idx = (d.getDay() + 6) % 7;
        daily[idx] += earn;
      });

      const max = Math.max(...daily, 0.01);

      const title = document.createElement("div");
      title.textContent = "Earnings this week by day";
      analyticsContent.appendChild(title);

      const wrap = document.createElement("div");
      wrap.className = "week-bars";

      const labels = ["M", "T", "W", "T", "F", "S", "S"];
      daily.forEach((val, i) => {
        const col = document.createElement("div");
        col.className = "week-bar";
        const fill = document.createElement("div");
        fill.className = "week-bar-fill";
        fill.style.height = (val / max * 100).toFixed(0) + "%";
        const amt = document.createElement("div");
        amt.style.fontSize = "0.6rem";
        amt.textContent = val > 0 ? "$" + val.toFixed(0) : "";
        const lab = document.createElement("div");
        lab.className = "week-bar-label";
        lab.textContent = labels[i];
        col.appendChild(fill);
        col.appendChild(amt);
        col.appendChild(lab);
        wrap.appendChild(col);
      });

      analyticsContent.appendChild(wrap);

      const note = document.createElement("div");
      note.className = "helper";
      note.textContent = "Fast way to see which days are paying and which are cosplay.";
      analyticsContent.appendChild(note);
    }

    if (view === "apps") {
      const byApp = {};
      runs.forEach(r => {
        const h = calcHours(r.start, r.end);
        if (h <= 0) return;
        const earn = r.earnings || 0;
        if (!byApp[r.app]) byApp[r.app] = 0;
        byApp[r.app] += earn;
      });

      const apps = Object.keys(byApp).filter(a => byApp[a] > 0);
      if (!apps.length) {
        const d = document.createElement("div");
        d.className = "helper";
        d.textContent = "Once you have earnings, Duddy will split by app.";
        analyticsContent.appendChild(d);
        return;
      }

      const total = apps.reduce((s, a) => s + byApp[a], 0);
      const title = document.createElement("div");
      title.textContent = "Earnings share by app (all time)";
      analyticsContent.appendChild(title);

      const bar = document.createElement("div");
      bar.className = "app-share-bar";

      const colors = [
        "rgba(56,189,248,0.9)",
        "rgba(22,163,74,0.9)",
        "rgba(249,115,22,0.9)",
        "rgba(129,140,248,0.9)",
        "rgba(236,72,153,0.9)",
        "rgba(148,163,253,0.9)"
      ];

      const legend = document.createElement("div");
      legend.className = "app-share-legend";

      apps.forEach((app, idx) => {
        const share = byApp[app] / total;
        const seg = document.createElement("div");
        seg.className = "app-share-seg";
        seg.style.flex = share.toFixed(4);
        seg.style.background = colors[idx % colors.length];
        bar.appendChild(seg);

        const item = document.createElement("div");
        item.className = "legend-item";
        const sw = document.createElement("div");
        sw.className = "legend-swatch";
        sw.style.background = colors[idx % colors.length];
        const txt = document.createElement("span");
        txt.textContent =
          app + " " + Math.round(share * 100) + "% ($" + byApp[app].toFixed(0) + ")";
        item.appendChild(sw);
        item.appendChild(txt);
        legend.appendChild(item);
      });

      analyticsContent.appendChild(bar);
      analyticsContent.appendChild(legend);

      const note = document.createElement("div");
      note.className = "helper";
      note.textContent = "If one app is tiny, stop giving it free rent in your brain.";
      analyticsContent.appendChild(note);
    }
  }

  // Main render

  function render() {
    const runs = loadRuns();
    const activeDateStr = dateEl.value || todayStr();
    const activeDate = parseDateOnly(activeDateStr) || new Date();
    const weekStart = getWeekStart(activeDate);
    const weekEnd = new Date(weekStart.getTime());
    weekEnd.setDate(weekEnd.getDate() + 7);
    const shiftHoursForActive = calcShiftHours(activeDateStr);

    entriesList.innerHTML = "";

    if (!runs.length) {
      const div = document.createElement("div");
      div.className = "helper";
      div.textContent = "No runs yet. Start one and end with a single tap.";
      entriesList.appendChild(div);
    } else {
      const todays = runs.filter(r => r.date === activeDateStr);
      if (todays.length) {
        let cumEarn = 0;
        let cumHours = 0;
        todays.forEach(r => {
          const h = calcHours(r.start, r.end);
          if (h > 0) {
            cumHours += h;
            cumEarn += r.earnings || 0;
          }
        });
        const runAvg = cumHours > 0 ? cumEarn / cumHours : 0;

        let labelRate;
        if (shiftHoursForActive > 0 && cumEarn > 0) {
          const shiftRate = cumEarn / shiftHoursForActive;
          labelRate =
            "$" + cumEarn.toFixed(2) +
            " (" + runAvg.toFixed(1) + "/hr runs, " +
            shiftRate.toFixed(1) + "/hr shift)";
        } else if (runAvg > 0) {
          labelRate =
            "$" + cumEarn.toFixed(2) +
            " (" + runAvg.toFixed(1) + "/hr runs)";
        } else {
          labelRate = "$" + cumEarn.toFixed(2);
        }

        const summaryRow = document.createElement("div");
        summaryRow.className = "entry-row summary";
        summaryRow.innerHTML = `
          <span class="main">Today so far</span>
          <span class="app">${todays.length} runs</span>
          <span class="time">${formatDurationHM(cumHours) || "-"}</span>
          <span class="dur">${labelRate}</span>
        `;
        entriesList.appendChild(summaryRow);
      }

      runs.slice().reverse().forEach((r, idx) => {
        const row = document.createElement("div");
        row.className = "entry-row";

        const d = parseDateOnly(r.date);
        const dateLabel = d
          ? d.toLocaleDateString(undefined, { month: "short", day: "numeric" })
          : (r.date || "");

        const h = calcHours(r.start, r.end);
        const rate = h > 0 && r.earnings ? r.earnings / h : 0;
        const typeLabel =
          r.quick
            ? "Quick patch"
            : r.auto === true
            ? "Auto"
            : r.auto === false
            ? "Manual"
            : "Legacy";
        const durLabel = formatDurationHM(h);

        row.innerHTML = `
          <span class="main">${dateLabel}</span>
          <span class="app">${r.app}</span>
          <span class="time">${r.start || "?"} - ${r.end || "?"}</span>
          <span class="dur">${durLabel || "-"}</span>
        `;

        const rateSpan = document.createElement("span");
        rateSpan.className = "rate";
        rateSpan.textContent =
          h > 0 && r.earnings
            ? "$" + rate.toFixed(1) + "/hr"
            : "-";
        row.appendChild(rateSpan);

        const meta = document.createElement("span");
        meta.className = "meta";
        meta.textContent = typeLabel;
        row.appendChild(meta);

        if (r.notes) {
          const note = document.createElement("span");
          note.className = "note";
          note.textContent = r.notes;
          row.appendChild(note);
        }

        const edit = document.createElement("span");
        edit.className = "edit";
        edit.textContent = "Edit";
        edit.onclick = () => {
          const realIndex = runs.length - 1 - idx;
          const picked = runs[realIndex];
          editingIndex = realIndex;

          dateEl.value = picked.date;
          syncShiftInputs();

          appButtons.forEach(b => {
            if (b.dataset.app === picked.app) {
              b.classList.add("active");
              selectedApp = picked.app;
            } else {
              b.classList.remove("active");
            }
          });

          startEl.value = picked.start || "";
          endEl.value = picked.end || "";
          earningsEl.value = picked.earnings || "";
          ordersEl.value = picked.orders || "";
          notesEl.value = picked.notes || "";

          activeRun = null;
          saveActiveRun(null);
          stopRunTimer();
          runStatusEl.textContent =
            "Editing run. Adjust fields, then press End to save.";
        };
        row.appendChild(edit);

        const del = document.createElement("span");
        del.className = "delete";
        del.textContent = "Remove";
        del.onclick = () => {
          const realIndex = runs.length - 1 - idx;
          runs.splice(realIndex, 1);
          saveRuns(runs);
          if (editingIndex === realIndex) {
            editingIndex = null;
            runStatusEl.textContent = "No active run.";
          }
          render();
        };
        row.appendChild(del);

        entriesList.appendChild(row);
      });
    }

    // Stats
    let total = 0;
    let totalHours = 0;
    let todayEarn = 0;
    let todayHours = 0;
    let weekEarn = 0;
    let weekHours = 0;

    const byApp = {};
    const hourBuckets = {};

    const runs = loadRuns();

    runs.forEach(r => {
      if (!r.date) return;
      const d = parseDateOnly(r.date);
      if (!d) return;

      const h = calcHours(r.start, r.end);
      if (h <= 0) return;

      const earn = r.earnings || 0;

      total += earn;
      totalHours += h;

      if (!byApp[r.app]) byApp[r.app] = { earnings: 0, hours: 0 };
      byApp[r.app].earnings += earn;
      byApp[r.app].hours += h;

      if (r.start) {
        const hh = parseInt(r.start.split(":")[0], 10);
        if (!Number.isNaN(hh)) {
          if (!hourBuckets[hh]) hourBuckets[hh] = { earnings: 0, hours: 0 };
          hourBuckets[hh].earnings += earn;
          hourBuckets[hh].hours += h;
        }
      }

      if (r.date === activeDateStr) {
        todayEarn += earn;
        todayHours += h;
      }

      if (d >= weekStart && d < weekEnd) {
        weekEarn += earn;
        weekHours += h;
      }
    });

    const todayRate = todayHours > 0 ? (todayEarn / todayHours).toFixed(1) : "0.0";
    const weekRate = weekHours > 0 ? (weekEarn / weekHours).toFixed(1) : "0.0";
    const allRate = totalHours > 0 ? (total / totalHours).toFixed(1) : "0.0";

    statTotal.textContent =
      "Today $" + todayEarn.toFixed(2) +
      " | Week $" + weekEarn.toFixed(2) +
      " | All $" + total.toFixed(2);

    let perHourText =
      "Today $" + todayRate +
      " | Week $" + weekRate +
      " | All $" + allRate;

    if (shiftHoursForActive > 0 && todayEarn > 0) {
      const shiftRate = (todayEarn / shiftHoursForActive).toFixed(1);
      perHourText =
        "Today runs $" + todayRate +
        " / shift $" + shiftRate +
        " | Week $" + weekRate +
        " | All $" + allRate;
    }

    statPerHour.textContent = perHourText;

    // Top app
    let topApp = "None";
    let topRate = 0;
    Object.keys(byApp).forEach(app => {
      const { earnings, hours } = byApp[app];
      if (hours > 0 && earnings > 0) {
        const r = earnings / hours;
        if (r > topRate) {
          topRate = r;
          topApp = app;
        }
      }
    });
    statTopApp.textContent =
      topApp !== "None"
        ? topApp + " (" + topRate.toFixed(1) + "/hr)"
        : "None";

    // Hot hours
    let bestBucket = null;
    let bestBucketRate = 0;
    Object.keys(hourBuckets).forEach(hStr => {
      const h = parseInt(hStr, 10);
      const { earnings, hours } = hourBuckets[h];
      if (hours > 0 && earnings > 0) {
        const r = earnings / hours;
        if (r > bestBucketRate) {
          bestBucketRate = r;
          bestBucket = h;
        }
      }
    });

    if (bestBucket !== null) {
      const endH = (bestBucket + 2) % 24;
      const fmt = x => {
        const suf = x >= 12 ? "pm" : "am";
        const h12 = x % 12 === 0 ? 12 : x % 12;
        return h12 + suf;
      };
      statHotHours.textContent =
        fmt(bestBucket) + " to " + fmt(endH) +
        " (" + bestBucketRate.toFixed(1) + "/hr)";
    } else {
      statHotHours.textContent = "Need more data";
    }

    updateShiftStats();
    renderAnalytics(runs);

    if (activeRun && activeRun.startTs) {
      startRunTimer();
    } else if (editingIndex === null) {
      stopRunTimer();
    }
  }

  // Event wiring

  appButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      appButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedApp = btn.dataset.app;
      if (activeRun && activeRun.startTs) {
        runStatusEl.textContent =
          "Active run for " + selectedApp + ".";
      }
    });
  });

  analyticsTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      analyticsTabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      render();
    });
  });

  dateEl.addEventListener("change", () => {
    syncShiftInputs();
    updateShiftStats();
    render();
  });

  [shiftStartTimeEl, shiftEndTimeEl, shiftStartKmEl, shiftEndKmEl, shiftFuelEl]
    .forEach(el => {
      el.addEventListener("change", updateShiftFromInputs);
      el.addEventListener("blur", updateShiftFromInputs);
    });

  if (finalizeDayBtn) {
    finalizeDayBtn.addEventListener("click", () => {
      const dateStr = dateEl.value || todayStr();
      exportDayCsv(dateStr);
    });
  }

  startRunBtn.addEventListener("click", () => {
    if (editingIndex !== null) {
      alert("Finish editing or clear the form before starting a new run.");
      return;
    }
    if (activeRun && activeRun.startTs) {
      alert("A run is already active. Use End or a quick button.");
      return;
    }

    const now = new Date();
    const dateStr = dateEl.value || todayStr();

    activeRun = {
      app: selectedApp,
      startTs: now.toISOString(),
      date: dateStr
    };
    saveActiveRun(activeRun);

    runStatusEl.textContent =
      "Active run for " + selectedApp +
      " since " + formatTimeForInput(now);
    startRunTimer();
  });

  function finalizeRun(modeMins) {
    if (!activeRun || !activeRun.startTs) {
      if (editingIndex !== null) {
        const runs = loadRuns();
        const idx = editingIndex;
        const base = runs[idx];

        const date = dateEl.value || base.date || todayStr();
        const app = selectedApp || base.app;
        const start = startEl.value || base.start;
        const end = endEl.value || base.end;
        const earningsVal = earningsEl.value || base.earnings || "0";
        const ordersVal = ordersEl.value || base.orders || "0";
        const notes = (notesEl.value || base.notes || "").trim();

        if (!start || !end) {
          alert("Set start and end.");
          return;
        }
        const earnings = parseFloat(earningsVal);
        if (Number.isNaN(earnings) || earnings < 0) {
          alert("Set a valid earnings value.");
          return;
        }

        const hours = calcHours(start, end);
        if (hours <= 0) {
          alert("Time range is invalid.");
          return;
        }

        const orders = parseInt(ordersVal, 10) || 0;

        runs[idx] = {
          ...base,
          date,
          app,
          start,
          end,
          earnings,
          orders,
          notes,
          auto: false,
          quick: false
        };
        saveRuns(runs);

        editingIndex = null;
        startEl.value = "";
        endEl.value = "";
        earningsEl.value = "";
        ordersEl.value = "";
        notesEl.value = "";
        runStatusEl.textContent = "No active run.";
        render();
        return;
      }

      alert("No active run. Start run first, or use the manual form to log one.");
      return;
    }

    const runs = loadRuns();
    const startDate = new Date(activeRun.startTs);
    const date = activeRun.date || todayStr();
    const app = activeRun.app || selectedApp;

    const startStr = formatTimeForInput(startDate);
    let endStr;
    let quick = false;

    if (modeMins && modeMins > 0) {
      quick = true;
      const patched = new Date(startDate.getTime() + modeMins * 60000);
      endStr = formatTimeForInput(patched);
    } else {
      endStr = formatTimeForInput(new Date());
    }

    const hours = calcHours(startStr, endStr);
    if (hours <= 0) {
      alert("Run time came out invalid. Nothing saved.");
      return;
    }

    let earnings = 0;
    const input = prompt(
      "Earnings for this run (optional). Leave blank for zero.",
      ""
    );
    if (input !== null && input.trim() !== "") {
      const val = parseFloat(input.trim());
      if (!Number.isNaN(val) && val >= 0) {
        earnings = val;
      }
    }

    const entry = {
      date,
      app,
      start: startStr,
      end: endStr,
      earnings,
      orders: 0,
      notes: quick
        ? "Quick " + modeMins + " min patch"
        : "Full run",
      auto: true,
      quick
    };

    runs.push(entry);
    saveRuns(runs);

    activeRun = null;
    saveActiveRun(null);
    stopRunTimer();
    runStatusEl.textContent = "Run saved.";
    render();
  }

  endRunFullBtn.addEventListener("click", () => {
    finalizeRun(null);
  });

  patchButtons.forEach(btn => {
    const mins = parseInt(btn.dataset.mins, 10);
    btn.addEventListener("click", () => {
      finalizeRun(mins);
    });
  });

  clearAllBtn.addEventListener("click", () => {
    const ok = confirm("Clear all Duddy data on this device?");
    if (!ok) return;

    saveRuns([]);
    saveShifts([]);
    activeRun = null;
    saveActiveRun(null);
    editingIndex = null;

    stopRunTimer();
    stopShiftTimer();

    dateEl.value = todayStr();
    shiftStartTimeEl.value = "";
    shiftEndTimeEl.value = "";
    shiftStartKmEl.value = "";
    shiftEndKmEl.value = "";
    shiftFuelEl.value = "";
    startEl.value = "";
    endEl.value = "";
    earningsEl.value = "";
    ordersEl.value = "";
    notesEl.value = "";
    runStatusEl.textContent = "No active run.";

    updateDutyBar();
    render();
  });

  // Init
  if (!dateEl.value) {
    dateEl.value = todayStr();
  }
  syncShiftInputs();
  updateDutyBar();
  render();
});
</script>
</body>
</html>
