<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ShiftIntel - Driver Performance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-size: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
      --bg: #020817;
      --card: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97316;
      --radius-xl: 18px;
      --radius-xxl: 26px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.55);
      --gap-lg: 18px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 14px;
      background: radial-gradient(circle at top, #111827 0, #020817 42%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: var(--gap-lg);
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .pill-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 0.66rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.18);
      backdrop-filter: blur(8px);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 50%) no-repeat,
                  var(--card);
      border-radius: var(--radius-xxl);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 253, 0.08);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-label {
      font-size: 0.74rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .section-title {
      font-size: 0.82rem;
      color: var(--muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .app-buttons {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 2px;
    }

    .app-btn {
      padding: 10px 8px;
      font-size: 0.9rem;
      border-radius: 16px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .app-btn span {
      font-weight: 600;
    }

    .app-btn.active {
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(56,189,248,0.35);
      transform: translateY(-1px);
    }

    .app-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15,23,42,0.8);
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px;
    }

    .field,
    .field-full {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    input {
      padding: 10px 10px;
      font-size: 1.05rem;
      border-radius: 14px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(5, 12, 25, 0.98);
      color: var(--text);
      outline: none;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      transition: border-color var(--transition-fast), background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    input:focus {
      border-color: var(--accent);
      background: rgba(5, 13, 27, 1);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
      transform: translateY(-1px);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    button {
      padding: 11px 10px;
      border-radius: 999px;
      border: none;
      font-size: 1.02rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      flex: 1.6;
      background: linear-gradient(to right, var(--accent), #22c55e);
      color: #020817;
      box-shadow: 0 10px 26px rgba(56,189,248,0.32);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(56,189,248,0.42);
    }

    .btn-secondary {
      flex: 1.2;
      background: rgba(9, 9, 11, 0.98);
      color: var(--muted);
      border: 1px solid rgba(75,85,99,0.9);
    }

    .btn-secondary:hover {
      background: rgba(15,23,42,1);
      color: var(--accent);
      border-color: rgba(56,189,248,0.22);
      transform: translateY(-1px);
    }

    .btn-subtle {
      flex: 0.9;
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 0.8rem;
    }

    .btn-subtle:hover {
      background: rgba(15,23,42,1);
      border-color: var(--danger);
      transform: translateY(-1px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      padding: 10px 10px 8px;
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top, var(--accent-soft), transparent 80%) no-repeat,
                  rgba(6, 11, 23, 0.96);
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.14em;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 2px;
    }

    .stat-note {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 2px;
      max-width: 150px;
    }

    .entries-card {
      max-height: 200px;
      overflow-y: auto;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(75,85,99,0.9);
      padding: 6px 6px 4px;
      background: rgba(3,7,18,0.98);
      display: flex;
      flex-direction: column;
      gap: 4px;
      scrollbar-width: thin;
    }

    .entry-row {
      display: grid;
      grid-template-columns: 0.9fr 0.7fr 0.7fr 0.7fr;
      gap: 4px;
      padding: 6px 6px;
      border-radius: 10px;
      background: rgba(9,9,11,1);
      align-items: center;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .entry-row span.main {
      color: var(--text);
      font-weight: 500;
      font-size: 0.75rem;
    }

    .entry-row span.app {
      color: var(--accent);
      font-weight: 500;
    }

    .entry-row span.rate {
      color: #22c55e;
      font-weight: 600;
    }

    .entry-row span.delete {
      grid-column: 1 / -1;
      text-align: right;
      font-size: 0.6rem;
      color: var(--danger);
      cursor: pointer;
      opacity: 0.7;
    }

    .helper {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: -2px;
    }

    .running-label {
      font-size: 0.7rem;
      color: var(--accent);
      margin-top: 2px;
    }

    .manual-note {
      font-size: 0.6rem;
      color: var(--muted);
      margin-top: 2px;
    }

    @media (max-width: 400px) {
      .title {
        font-size: 1.7rem;
      }
      .entry-row {
        grid-template-columns: 1.1fr 0.7fr 0.7fr 0.7fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title">ShiftIntel</div>
    <div class="subtitle">Tap your app. Tap start. Drive. Numbers take care of themselves.</div>
    <div class="pill-row">
      <div class="pill">Multi app runs</div>
      <div class="pill">Auto time stamps</div>
      <div class="pill">Heatmap ready</div>
    </div>
  </header>

  <section class="card">
    <div class="card-label">Step 1</div>
    <div class="section-title">Who are you online with</div>
    <div class="app-buttons" id="appButtons">
      <button class="app-btn active" data-app="Uber Eats"><span>Uber Eats</span></button>
      <button class="app-btn" data-app="DoorDash"><span>DoorDash</span></button>
      <button class="app-btn" data-app="SkipTheDishes"><span>Skip</span></button>
      <button class="app-btn" data-app="Instacart"><span>Instacart</span></button>
      <button class="app-btn" data-app="Uber Rides"><span>Uber Rides</span></button>
      <button class="app-btn" data-app="Other"><span>Other</span></button>
    </div>
  </section>

  <section class="card" id="entry-card">
    <div class="card-label">Step 2</div>
    <div class="section-title">Track this run in two taps</div>

    <div class="field-grid">
      <div class="field">
        <label for="date">Date</label>
        <input type="date" id="date" />
      </div>
      <div class="field">
        <label>Auto times</label>
        <div id="autoTimeInfo" class="helper">Tap Start when you go online. Tap End when you wrap.</div>
      </div>
      <div class="field">
        <label for="earnings">Earnings ($)</label>
        <input type="number" id="earnings" inputmode="decimal" placeholder="Total this run" />
      </div>
      <div class="field">
        <label for="orders">Orders</label>
        <input type="number" id="orders" inputmode="numeric" placeholder="Trips" />
      </div>
      <div class="field-full">
        <label for="notes">Quick note (optional)</label>
        <input type="text" id="notes" placeholder="Zone, promos, surge, dead time, etc." />
      </div>
      <div class="field">
        <label for="start">Start time (auto or manual)</label>
        <input type="time" id="start" />
      </div>
      <div class="field">
        <label for="end">End time (auto or manual)</label>
        <input type="time" id="end" />
      </div>
    </div>

    <div class="helper">
      Normal use: choose app, hit Start when you begin, End when done, add earnings, save.
    </div>
    <div id="runningLabel" class="running-label"></div>
    <div class="manual-note">
      If you forget to tap Start, you can fill times manually. Data still feeds your heatmaps.
    </div>

    <div class="btn-row">
      <button class="btn-primary" id="startRunBtn">Start run</button>
      <button class="btn-secondary" id="endRunBtn">End run and save</button>
      <button class="btn-subtle" id="clearAllBtn">Clear all</button>
    </div>
  </section>

  <section class="card">
    <div class="card-label">Live stats</div>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-label">Total earned</div>
        <div class="stat-value" id="statTotal">$0</div>
        <div class="stat-note">All logged runs on this device.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Avg $ / hr</div>
        <div class="stat-value" id="statPerHour">$0</div>
        <div class="stat-note">Gut check on whether this is worth your time.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Top app</div>
        <div class="stat-value" id="statTopApp">None</div>
        <div class="stat-note">By average hourly earnings.</div>
      </div>
      <div class="stat">
        <div class="stat-label">Hot hours</div>
        <div class="stat-value" id="statHotHours">Need more data</div>
        <div class="stat-note">Best two hour window based on your logs.</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-label">Recent runs</div>
    <div class="entries-card" id="entriesList">
      <div class="helper">Once you log a few runs you will see short rows here with $ and app and hourly.</div>
    </div>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "shiftintel_runs_v2";
  const ACTIVE_RUN_KEY = "shiftintel_active_run";

  const dateEl = document.getElementById("date");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const earningsEl = document.getElementById("earnings");
  const ordersEl = document.getElementById("orders");
  const notesEl = document.getElementById("notes");
  const entriesList = document.getElementById("entriesList");
  const runningLabel = document.getElementById("runningLabel");
  const autoTimeInfo = document.getElementById("autoTimeInfo");

  const statTotal = document.getElementById("statTotal");
  const statPerHour = document.getElementById("statPerHour");
  const statTopApp = document.getElementById("statTopApp");
  const statHotHours = document.getElementById("statHotHours");

  const startRunBtn = document.getElementById("startRunBtn");
  const endRunBtn = document.getElementById("endRunBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  const appButtonsContainer = document.getElementById("appButtons");
  const appButtons = appButtonsContainer
    ? Array.from(appButtonsContainer.querySelectorAll(".app-btn"))
    : [];

  let selectedApp = "Uber Eats";
  let activeRun = loadActiveRun();

  function setToday() {
    dateEl.value = new Date().toISOString().slice(0, 10);
  }

  function loadEntries() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  function saveEntries(entries) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    } catch (e) {
      console.error("Failed to save entries", e);
    }
  }

  function loadActiveRun() {
    try {
      const raw = localStorage.getItem(ACTIVE_RUN_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.startTs) return null;
      return obj;
    } catch {
      return null;
    }
  }

  function saveActiveRun(run) {
    try {
      if (!run) {
        localStorage.removeItem(ACTIVE_RUN_KEY);
      } else {
        localStorage.setItem(ACTIVE_RUN_KEY, JSON.stringify(run));
      }
    } catch (e) {
      console.error("Failed to save active run", e);
    }
  }

  function formatTimeForInput(date) {
    const h = date.getHours().toString().padStart(2, "0");
    const m = date.getMinutes().toString().padStart(2, "0");
    return h + ":" + m;
  }

  function calcHours(start, end) {
    if (!start || !end) return 0;
    const partsS = start.split(":");
    const partsE = end.split(":");
    if (partsS.length < 2 || partsE.length < 2) return 0;
    const sh = Number(partsS[0]);
    const sm = Number(partsS[1]);
    const eh = Number(partsE[0]);
    const em = Number(partsE[1]);
    if (Number.isNaN(sh) || Number.isNaN(sm) || Number.isNaN(eh) || Number.isNaN(em)) return 0;

    let startMin = sh * 60 + sm;
    let endMin = eh * 60 + em;
    if (endMin <= startMin) {
      endMin += 24 * 60;
    }
    return (endMin - startMin) / 60;
  }

  function getHourBucketLabel(h) {
    const end = (h + 2) % 24;
    const fmt = (x) => {
      const suf = x >= 12 ? "pm" : "am";
      const h12 = x % 12 === 0 ? 12 : x % 12;
      return h12 + suf;
    };
    return fmt(h) + " to " + fmt(end);
  }

  function render() {
    const entries = loadEntries();
    entriesList.innerHTML = "";

    if (!entries.length) {
      const div = document.createElement("div");
      div.className = "helper";
      div.textContent = "Log some runs and your best apps and times will show here.";
      entriesList.appendChild(div);
    } else {
      entries
        .slice()
        .reverse()
        .forEach((e, idx) => {
          const row = document.createElement("div");
          row.className = "entry-row";

          const dateLabel = new Date(e.date).toLocaleDateString(undefined, {
            month: "short",
            day: "numeric"
          });

          const h = e.hours || 0;
          const rate = h > 0 ? e.earnings / h : 0;

          row.innerHTML = `
            <span class="main">${dateLabel} ${e.start || ""}</span>
            <span class="app">${e.app}</span>
            <span>$${e.earnings.toFixed(2)}</span>
            <span class="rate">${h > 0 ? "$" + rate.toFixed(1) + "/hr" : "-"}</span>
          `;

          if (e.notes) {
            const note = document.createElement("span");
            note.style.gridColumn = "1 / -1";
            note.style.fontSize = "0.62rem";
            note.style.color = "#6b7280";
            note.textContent = e.notes;
            row.appendChild(note);
          }

          const del = document.createElement("span");
          del.className = "delete";
          del.textContent = "Remove";
          del.onclick = () => {
            const realIndex = entries.length - 1 - idx;
            entries.splice(realIndex, 1);
            saveEntries(entries);
            render();
          };
          row.appendChild(del);

          entriesList.appendChild(row);
        });
    }

    let total = 0;
    let totalHours = 0;
    const byApp = {};
    const hourBuckets = {};

    entries.forEach((e) => {
      total += e.earnings;
      totalHours += e.hours;

      if (!byApp[e.app]) byApp[e.app] = { earnings: 0, hours: 0 };
      byApp[e.app].earnings += e.earnings;
      byApp[e.app].hours += e.hours;

      if (e.start && e.end && e.hours > 0) {
        const parts = e.start.split(":");
        if (parts.length >= 1) {
          const sh = parseInt(parts[0], 10);
          if (!Number.isNaN(sh)) {
            if (!hourBuckets[sh]) hourBuckets[sh] = { earnings: 0, hours: 0 };
            hourBuckets[sh].earnings += e.earnings;
            hourBuckets[sh].hours += e.hours;
          }
        }
      }
    });

    statTotal.textContent = "$" + total.toFixed(2);
    statPerHour.textContent = totalHours > 0
      ? "$" + (total / totalHours).toFixed(1)
      : "$0";

    let topApp = "None";
    let topRate = 0;
    Object.keys(byApp).forEach((app) => {
      const { earnings, hours } = byApp[app];
      if (hours > 0) {
        const r = earnings / hours;
        if (r > topRate && earnings > 0) {
          topRate = r;
          topApp = app;
        }
      }
    });
    statTopApp.textContent = topApp !== "None"
      ? topApp + " (" + topRate.toFixed(1) + "/hr)"
      : "None";

    let bestBucket = null;
    let bestBucketRate = 0;
    Object.keys(hourBuckets).forEach((hStr) => {
      const h = parseInt(hStr, 10);
      const { earnings, hours } = hourBuckets[h];
      if (hours > 0) {
        const r = earnings / hours;
        if (r > bestBucketRate && earnings > 0) {
          bestBucketRate = r;
          bestBucket = h;
        }
      }
    });

    if (bestBucket !== null) {
      statHotHours.textContent =
        getHourBucketLabel(bestBucket) + " (" + bestBucketRate.toFixed(1) + "/hr)";
    } else {
      statHotHours.textContent = "Need more data";
    }

    if (activeRun && activeRun.startTs) {
      const started = new Date(activeRun.startTs);
      const app = activeRun.app || selectedApp;
      runningLabel.textContent =
        "Running " + app + " since " +
        started.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    } else {
      runningLabel.textContent = "";
    }
  }

  if (appButtons.length) {
    appButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        appButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        selectedApp = btn.dataset.app;
        if (activeRun && activeRun.startTs) {
          runningLabel.textContent =
            "Running " + selectedApp + " (set for this run).";
        }
      });
    });
  }

  if (startRunBtn) {
    startRunBtn.addEventListener("click", () => {
      if (activeRun && activeRun.startTs) {
        alert("A run is already active. End it before starting a new one.");
        return;
      }

      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);

      activeRun = {
        app: selectedApp,
        startTs: now.toISOString(),
        date: dateStr
      };
      saveActiveRun(activeRun);

      dateEl.value = dateStr;
      startEl.value = formatTimeForInput(now);
      endEl.value = "";
      autoTimeInfo.textContent = "Start time captured. Drive. Tap End when done.";
      runningLabel.textContent =
        "Running " + selectedApp + " since " +
        now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      render();
    });
  }

  if (endRunBtn) {
    endRunBtn.addEventListener("click", () => {
      const entries = loadEntries();
      const now = new Date();

      let date = dateEl.value || now.toISOString().slice(0, 10);
      let app = selectedApp;
      let start;
      let end;

      if (activeRun && activeRun.startTs) {
        const startDate = new Date(activeRun.startTs);
        date = activeRun.date || date;
        app = activeRun.app || selectedApp;
        start = formatTimeForInput(startDate);
        end = formatTimeForInput(now);
        startEl.value = start;
        endEl.value = end;
      } else {
        start = startEl.value;
        end = endEl.value || formatTimeForInput(now);
        if (!start || !end) {
          alert("No active run. Use Start and End, or fill start and end manually.");
          return;
        }
      }

      const earnings = parseFloat(earningsEl.value || "0");
      const orders = parseInt(ordersEl.value || "0", 10);
      const notes = notesEl.value.trim();

      if (!earnings || earnings <= 0) {
        alert("Enter your earnings for this run so the stats mean something.");
        return;
      }

      const hours = calcHours(start, end);
      if (hours <= 0) {
        alert("Time math looks off. Adjust start or end.");
        return;
      }

      entries.push({ date, app, start, end, earnings, orders, notes, hours });
      saveEntries(entries);

      activeRun = null;
      saveActiveRun(null);

      earningsEl.value = "";
      ordersEl.value = "";
      notesEl.value = "";
      startEl.value = "";
      endEl.value = "";
      autoTimeInfo.textContent = "Tap Start when you go online. Tap End when you wrap.";
      runningLabel.textContent = "";

      render();
    });
  }

  if (clearAllBtn) {
    clearAllBtn.addEventListener("click", () => {
      const ok = confirm("Wipe all runs from this device");
      if (!ok) return;

      saveEntries([]);
      activeRun = null;
      saveActiveRun(null);

      earningsEl.value = "";
      ordersEl.value = "";
      notesEl.value = "";
      startEl.value = "";
      endEl.value = "";
      runningLabel.textContent = "";
      autoTimeInfo.textContent = "Tap Start when you go online. Tap End when you wrap.";

      render();
    });
  }

  setToday();
  render();
});
</script>
</body>
</html>
